# dml_keyword_search v0.1
# Extend the search function to allow keyword searching
# Dan Lowe
# http://tangledhelix.com/

# ......................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# ......................................................................

YTo5OntzOjc6InZlcnNpb24iO3M6MzoiMC4xIjtzOjY6ImF1dGhvciI7czo4OiJEYW4gTG93
ZSI7czoxMDoiYXV0aG9yX3VyaSI7czoyNDoiaHR0cDovL3RhbmdsZWRoZWxpeC5jb20vIjtz
OjExOiJkZXNjcmlwdGlvbiI7czo1MzoiRXh0ZW5kIHRoZSBzZWFyY2ggZnVuY3Rpb24gdG8g
YWxsb3cga2V5d29yZCBzZWFyY2hpbmciO3M6NDoidHlwZSI7aTowO3M6NDoibmFtZSI7czox
ODoiZG1sX2tleXdvcmRfc2VhcmNoIjtzOjQ6ImhlbHAiO3M6MTkyOiIKPHA+PHN0cm9uZz50
eHA6ZG1sX2tleXdvcmRfc2VhcmNoPC9zdHJvbmc+PC9wPgoKPHA+VGhpcyBwbHVnaW4gbWFr
ZXMgaXQgcG9zc2libGUgdG8gZG8gYSBzZWFyY2ggYWdhaW5zdCBrZXl3b3JkcyBpbiBhZGRp
dGlvbiB0bwp0aGUgdXN1YWwgdGl0bGUgYW5kIGJvZHkuPC9wPgoKPHA+SSdsbCB3cml0ZSBo
ZWxwIHNvbWVkYXkuPC9wPgoiO3M6NDoiY29kZSI7czoyMDUzOiIKLy8ge3t7IF9kbWxfa2V5
d29yZF9zZWFyY2hfZG9fc2VhcmNoKCkKCmZ1bmN0aW9uIF9kbWxfa2V5d29yZF9zZWFyY2hf
ZG9fc2VhcmNoKCRhdHRzLCAkY291bnRfb25seSkKewogICAgZ2xvYmFsICRxOwoKICAgIGV4
dHJhY3QobEF0dHMoYXJyYXkoCiAgICAgICAgJ2xpbWl0JyA9PiA1MDAKICAgICksJGF0dHMp
KTsKCiAgICBpZiAoJHEgIT0gJycpCiAgICB7CiAgICAgICAgLy8gcHJldmVudCBzZWFyY2hl
cyBpbiBzZWN0aW9ucyB3aGVyZSBzZWFyY2ggaXMgZGlzYWJsZWQKICAgICAgICAkc19maWx0
ZXIgPSAnJzsKICAgICAgICAkcnMgPSBzYWZlX2NvbHVtbignbmFtZScsICd0eHBfc2VjdGlv
bicsICJzZWFyY2hhYmxlICE9ICcxJyIpOwogICAgICAgIGlmICgkcnMpCiAgICAgICAgewog
ICAgICAgICAgICBmb3JlYWNoICgkcnMgYXMgJG5hbWUpCiAgICAgICAgICAgICAgICAkZmls
dGVyc1tdID0gImFuZCBTZWN0aW9uICE9ICckbmFtZSciOwogICAgICAgICAgICAkc19maWx0
ZXIgPSBqb2luKCcgJywkZmlsdGVycyk7CiAgICAgICAgfQoKICAgICAgICAvLyBjb25zdHJ1
Y3QgcXVlcnkKICAgICAgICAkc2VsZWN0ID0gIiosIHVuaXhfdGltZXN0YW1wKFBvc3RlZCkg
YXMgdVBvc3RlZCwiCiAgICAgICAgICAgICAgICAuICIgbWF0Y2ggKFRpdGxlLEJvZHksS2V5
d29yZHMpIGFnYWluc3QgKCckcScpIGFzIHNjb3JlIjsKCiAgICAgICAgJHdoZXJlID0gIihU
aXRsZSBybGlrZSAnJHEnIG9yIEJvZHkgcmxpa2UgJyRxJyBvciBLZXl3b3JkcyBybGlrZSAn
JHEnKSIKICAgICAgICAgICAgICAgLiAiICRzX2ZpbHRlciBhbmQgU3RhdHVzID0gNCBhbmQg
UG9zdGVkIDw9IG5vdygpIgogICAgICAgICAgICAgICAuICIgb3JkZXIgYnkgc2NvcmUgZGVz
YyBsaW1pdCAkbGltaXQiOwoKICAgICAgICAkcnMgPSBzYWZlX3Jvd3MoJHNlbGVjdCwgJ3Rl
eHRwYXR0ZXJuJywgJHdoZXJlKTsKCiAgICAgICAgaWYgKCRjb3VudF9vbmx5KQogICAgICAg
ICAgICByZXR1cm4gY291bnQoJHJzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVy
biAkcnM7CiAgICB9CgogICAgcmV0dXJuICcnOwp9CgovLyB9fX0KCi8vIHt7eyBkbWxfa2V5
d29yZF9zZWFyY2goKQoKZnVuY3Rpb24gZG1sX2tleXdvcmRfc2VhcmNoKCRhdHRzKQp7CiAg
ICAkcnMgPSBfZG1sX2tleXdvcmRfc2VhcmNoX2RvX3NlYXJjaCgkYXR0cyk7CgogICAgaWYg
KCRycykKICAgIHsKICAgICAgICAkYXJ0aWNsZXMgPSBhcnJheSgpOwoKICAgICAgICBmb3Jl
YWNoICgkcnMgYXMgJGEpCiAgICAgICAgewogICAgICAgICAgICBwb3B1bGF0ZUFydGljbGVE
YXRhKCRhKTsKICAgICAgICAgICAgJGZvcm0gPSBnQXR0KCRhdHRzLCAnc2VhcmNoZm9ybScs
ICdzZWFyY2hfcmVzdWx0cycpOwogICAgICAgICAgICAkYXJ0aWNsZSA9IGZldGNoX2Zvcm0o
JGZvcm0pOwogICAgICAgICAgICAkYXJ0aWNsZXNbXSA9IHBhcnNlKCRhcnRpY2xlKTsKICAg
ICAgICB9CgogICAgICAgIHJldHVybiBqb2luICgnJywkYXJ0aWNsZXMpOwogICAgfQogICAg
cmV0dXJuICcnOwp9CgovLyB9fX0KCi8vIHt7eyBkbWxfa2V5d29yZF9zZWFyY2hfY291bnQo
KQoKZnVuY3Rpb24gZG1sX2tleXdvcmRfc2VhcmNoX2NvdW50KCRhdHRzKQp7CiAgICBleHRy
YWN0KGxBdHRzKGFycmF5KAogICAgICAgIHRleHQgICA9PiAnRm91bmQgJXMgbWF0Y2hlcycs
CiAgICAgICAgc2luZ2xlID0+ICdGb3VuZCAlcyBtYXRjaCcsCiAgICAgICAgemVybyAgID0+
ICdTb3JyeSwgdGhlcmUgd2VyZSBubyBtYXRjaGVzIGZvciB5b3VyIHF1ZXJ5JwogICAgKSwk
YXR0cykpOwoKICAgICRjb3VudCA9IF9kbWxfa2V5d29yZF9zZWFyY2hfZG9fc2VhcmNoKCRh
dHRzLCAnY291bnRfb25seScpOwoKICAgIGlmICAgICAoJGNvdW50ID09IDEpICAgJHJldCA9
ICRzaW5nbGU7CiAgICBlbHNlaWYgKCRjb3VudCA9PT0gMCkgICRyZXQgPSAkemVybzsKICAg
IGVsc2UgICAgICAgICAgICAgICAgICAgJHJldCA9ICR0ZXh0OwoKICAgIHJldHVybiBzdHJf
cmVwbGFjZSgnJXMnLCAkY291bnQsICRyZXQpOwp9CgovLyB9fX0KIjtzOjM6Im1kNSI7czoz
MjoiNmQ4OGNlNzk0ZGMwYzI3Mzk4NjJmN2EzZGY0NTAyMTciO30=
